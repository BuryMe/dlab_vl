<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶è¯­éŸ³è½¬æ–‡å­— DEMO - ä¼˜åŒ–ç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .control-panel {
            text-align: center;
            margin-bottom: 30px;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            margin: 0 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.recording { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeeba;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .audio-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }

        .audio-level {
            width: 100%;
            height: 15px;
            background: #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }

        .audio-level-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            width: 0%;
            transition: width 0.1s ease;
        }

        .audio-level-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }

        .transcription-area {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            min-height: 250px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .transcription-text {
            font-size: 16px;
            line-height: 1.8;
        }

        .real-time-text { 
            color: #007bff; 
            font-style: italic; 
            background: #e3f2fd;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 0;
            display: block;
        }
        .final-text { 
            color: #333; 
            font-weight: 500; 
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .server-response-area {
            background: #f1f3f5;
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .response-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .response-timestamp {
            color: #666;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .response-content {
            color: #333;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .debug-info {
            background: #f1f3f5;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ å®æ—¶è¯­éŸ³è½¬æ–‡å­— DEMO - ä¼˜åŒ–ç‰ˆ</h1>
        
        <div class="control-panel">
            <button id="connectBtn">è¿æ¥æœåŠ¡</button>
            <button id="startBtn" disabled>å¼€å§‹å½•éŸ³</button>
            <button id="stopBtn" disabled>åœæ­¢å½•éŸ³</button>
            <button id="clearBtn">æ¸…ç©ºæ‰€æœ‰å†…å®¹</button>
        </div>

        <div id="status" class="status disconnected">æœªè¿æ¥</div>
        
        <div id="audioInfo" class="audio-info">
            éŸ³é¢‘é…ç½®ï¼šé‡‡æ ·ç‡ 16KHz | é‡‡æ ·ç²¾åº¦ 16bit | å•å£°é“ | PCMæ ¼å¼ | æ•°æ®åˆ†ç‰‡ 1280å­—èŠ‚/40ms
        </div>
        
        <div class="audio-level">
            <div id="audioLevelBar" class="audio-level-bar"></div>
            <div id="audioLevelText" class="audio-level-text">éŸ³é‡: 0%</div>
        </div>

        <div id="errorMessage" class="error-message"></div>

        <div class="section-title">ğŸ“ è¯­éŸ³è¯†åˆ«ç»“æœ</div>
        <div class="transcription-area">
            <div id="transcriptionText" class="transcription-text">
                ç­‰å¾…å¼€å§‹è¯­éŸ³è¯†åˆ«...
            </div>
        </div>

        <div class="section-title">ğŸ“¡ æœåŠ¡ç«¯å®Œæ•´å“åº”</div>
        <div class="server-response-area">
            <div id="serverResponses">
                ç­‰å¾…æœåŠ¡ç«¯å“åº”...
            </div>
        </div>

        <div class="section-title">ğŸ”§ ç³»ç»Ÿè¯Šæ–­ä¿¡æ¯</div>
        <div id="debugInfo" class="debug-info">
            è¯Šæ–­ä¿¡æ¯å°†åœ¨æ­¤å¤„æ˜¾ç¤º...
        </div>
    </div>

    <script>
    class AudioRecorder {
        constructor(options = {}) {
            // æ—¥å¿—æ–¹æ³•ä¼˜å…ˆå®šä¹‰
            this.log = this.log.bind(this);
            this.showError = this.showError.bind(this);
            this.handleError = this.handleError.bind(this);

            // ä¸¥æ ¼æŒ‰ç…§ç§‘å¤§è®¯é£è§„èŒƒè®¾ç½®éŸ³é¢‘å‚æ•°
            this.sampleRate = 16000;        // å›ºå®š16KHz
            this.bitDepth = 16;             // å›ºå®š16bit
            this.channelCount = 1;          // å›ºå®šå•å£°é“
            this.frameSize = 1280;          // æ¯æ¬¡å‘é€1280å­—èŠ‚
            this.frameInterval = 40;        // æ¯40mså‘é€ä¸€æ¬¡
            
            // éŸ³é¢‘å¤„ç†ç›¸å…³
            this.audioContext = null;
            this.mediaStream = null;
            this.mediaStreamSource = null;
            this.processor = null;
            this.analyser = null;

            // WebSocket
            this.websocket = null;
            this.wsUrl = options.wsUrl || 'wss://0cea-101-44-83-177.ngrok-free.app/ws/transcribe';

            // çŠ¶æ€æ ‡å¿—
            this.isRecording = false;
            this.isWebSocketConnected = false;

            // éŸ³é¢‘ç¼“å†²åŒºç®¡ç†
            this.audioBuffer = [];
            this.bufferSize = 4096;
            this.sendTimer = null;

            // éŸ³é¢‘è´¨é‡ç›‘æ§
            this.audioStats = {
                totalFramesSent: 0,
                totalBytesSent: 0,
                avgVolumeLevel: 0,
                lastSendTime: 0
            };

            // åˆå§‹åŒ–
            this.initElements();
            this.bindEvents();
            
            // ä½¿ç”¨ç®­å¤´å‡½æ•°ç¡®ä¿thisæ­£ç¡®ç»‘å®š
            setTimeout(() => {
                this.log('ğŸš€ éŸ³é¢‘å½•åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ');
                this.log(`ğŸ“Š éŸ³é¢‘é…ç½®: ${this.sampleRate}Hz, ${this.bitDepth}bit, ${this.channelCount}å£°é“`);
            }, 0);
        }

        log(...args) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : arg
            ).join(' ');
            
            const fullLogMessage = `[${timestamp}] ${logMessage}`;
            
            // æ§åˆ¶å°æ—¥å¿—
            console.log(fullLogMessage);
            
            // UIæ—¥å¿—
            try {
                const logLine = document.createElement('div');
                logLine.textContent = fullLogMessage;
                
                // ç¡®ä¿debugInfoå…ƒç´ å­˜åœ¨
                const debugInfoElement = document.getElementById('debugInfo');
                if (debugInfoElement) {
                    debugInfoElement.appendChild(logLine);
                    debugInfoElement.scrollTop = debugInfoElement.scrollHeight;
                }
            } catch (error) {
                console.error('æ—¥å¿—è®°å½•å¤±è´¥', error);
            }
        }

        // é”™è¯¯å¤„ç†æ–¹æ³•
        showError(message) {
            console.error(message);
            try {
                const errorContainer = document.getElementById('errorMessage');
                if (errorContainer) {
                    errorContainer.textContent = message;
                    errorContainer.style.display = 'block';
                    
                    setTimeout(() => {
                        errorContainer.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('æ˜¾ç¤ºé”™è¯¯å¤±è´¥', error);
            }
        }

        handleError(error) {
            this.log('âŒ å‘ç”Ÿé”™è¯¯', error);
            this.showError(error.message || 'æœªçŸ¥é”™è¯¯');
        }

        initElements() {
            try {
                this.connectBtn = document.getElementById('connectBtn');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.clearBtn = document.getElementById('clearBtn');

                this.status = document.getElementById('status');
                this.audioLevelBar = document.getElementById('audioLevelBar');
                this.audioLevelText = document.getElementById('audioLevelText');
                this.debugInfo = document.getElementById('debugInfo');
                this.transcriptionText = document.getElementById('transcriptionText');
                this.serverResponses = document.getElementById('serverResponses');
                this.errorMessage = document.getElementById('errorMessage');

                this.stopBtn.disabled = true;
            } catch (error) {
                console.error('åˆå§‹åŒ–å…ƒç´ å¤±è´¥', error);
            }
        }

        bindEvents() {
            // ä½¿ç”¨ç®­å¤´å‡½æ•°ç¡®ä¿thisæ­£ç¡®ç»‘å®š
            this.connectBtn.addEventListener('click', () => this.connectWebSocket());
            this.startBtn.addEventListener('click', () => this.start());
            this.stopBtn.addEventListener('click', () => this.stop());
            this.clearBtn.addEventListener('click', () => this.clearAll());
        }

        async connectWebSocket() {
            try {
                this.log('ğŸ”— æ­£åœ¨è¿æ¥WebSocketæœåŠ¡...');
                this.websocket = new WebSocket(this.wsUrl);

                this.websocket.onopen = () => {
                    this.isWebSocketConnected = true;
                    this.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    this.status.textContent = 'å·²è¿æ¥ - å‡†å¤‡å°±ç»ª';
                    this.status.className = 'status connected';
                    
                    this.startBtn.disabled = false;
                    this.connectBtn.disabled = true;
                };

                this.websocket.onmessage = (event) => {
                    this.handleServerResponse(event.data);
                };

                this.websocket.onclose = (event) => {
                    this.isWebSocketConnected = false;
                    this.log(`âŒ WebSocketè¿æ¥å…³é—­ - Code: ${event.code}, Reason: ${event.reason}`);
                    this.status.textContent = 'è¿æ¥å·²æ–­å¼€';
                    this.status.className = 'status disconnected';
                    
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = true;
                    this.connectBtn.disabled = false;
                };

                this.websocket.onerror = (error) => {
                    this.log('âŒ WebSocketè¿æ¥é”™è¯¯', error);
                    this.showError('WebSocketè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
                };

            } catch (error) {
                this.log('âŒ WebSocketåˆå§‹åŒ–å¤±è´¥', error);
                this.showError('è¿æ¥å¤±è´¥ï¼š' + error.message);
            }
        }

        async start() {
            try {
                if (!this.isWebSocketConnected) {
                    throw new Error('è¯·å…ˆè¿æ¥WebSocketæœåŠ¡');
                }

                this.log('ğŸ¤ å¼€å§‹åˆå§‹åŒ–éŸ³é¢‘è®¾å¤‡...');

                // è¯·æ±‚éº¦å…‹é£æƒé™ï¼Œä¸¥æ ¼æŒ‰ç…§ç§‘å¤§è®¯é£è§„èŒƒ
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,      // å…³é—­å›å£°æ¶ˆé™¤
                        autoGainControl: false,       // å…³é—­è‡ªåŠ¨å¢ç›Š
                        noiseSuppression: false,      // å…³é—­å™ªå£°æŠ‘åˆ¶
                        sampleRate: this.sampleRate,  // 16KHz
                        channelCount: this.channelCount, // å•å£°é“
                        sampleSize: this.bitDepth     // 16bit
                    }
                });

                this.mediaStream = stream;

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿é‡‡æ ·ç‡æ­£ç¡®
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: this.sampleRate
                });

                // éªŒè¯éŸ³é¢‘ä¸Šä¸‹æ–‡çš„é‡‡æ ·ç‡
                if (this.audioContext.sampleRate !== this.sampleRate) {
                    this.log(`âš ï¸ éŸ³é¢‘ä¸Šä¸‹æ–‡é‡‡æ ·ç‡ä¸åŒ¹é…: æœŸæœ›${this.sampleRate}Hz, å®é™…${this.audioContext.sampleRate}Hz`);
                }

                // åˆ›å»ºéŸ³é¢‘æº
                this.mediaStreamSource = this.audioContext.createMediaStreamSource(stream);

                // åˆ›å»ºåˆ†æå™¨ç”¨äºéŸ³é‡ç›‘æ§
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 2048;

                // åˆ›å»ºéŸ³é¢‘å¤„ç†èŠ‚ç‚¹
                this.processor = this.audioContext.createScriptProcessor(
                    this.bufferSize, 
                    this.channelCount, 
                    this.channelCount
                );

                // ç»‘å®šéŸ³é¢‘å¤„ç†
                                this.processor.onaudioprocess = this.processAudioData.bind(this);

                // è¿æ¥éŸ³é¢‘å¤„ç†é“¾
                this.mediaStreamSource.connect(this.analyser);
                this.analyser.connect(this.processor);
                this.processor.connect(this.audioContext.destination);

                // å¯åŠ¨å®šæ—¶éŸ³é¢‘å‘é€æœºåˆ¶
                this.startAudioSendTimer();

                // æ›´æ–°UIçŠ¶æ€
                this.isRecording = true;
                this.startBtn.disabled = true;
                this.stopBtn.disabled = false;
                this.status.textContent = 'å½•éŸ³ä¸­';
                this.status.className = 'status recording';

                this.log('ğŸ¤ å¼€å§‹å½•éŸ³ï¼Œä¸¥æ ¼æŒ‰ç…§ç§‘å¤§è®¯é£è¯­éŸ³æ ‡å‡†');

            } catch (error) {
                this.log('âŒ å½•éŸ³åˆå§‹åŒ–å¤±è´¥', error);
                this.handleError(error);
            }
        }

        processAudioData(event) {
            if (!this.isRecording) return;

            const inputBuffer = event.inputBuffer;
            const inputData = inputBuffer.getChannelData(0);

            // æ›´æ–°éŸ³é‡æ˜¾ç¤º
            this.updateAudioLevelDisplay(inputData);

            // ç¼“å­˜éŸ³é¢‘æ•°æ®
            this.audioBuffer.push(...inputData);
        }

        startAudioSendTimer() {
            // æŒ‰ç§‘å¤§è®¯é£è§„èŒƒï¼Œæ¯40mså‘é€1280å­—èŠ‚æ•°æ®
            this.sendTimer = setInterval(() => {
                if (this.audioBuffer.length >= this.frameSize / 2) {
                    const audioChunk = this.audioBuffer.slice(0, this.frameSize / 2);
                    this.audioBuffer = this.audioBuffer.slice(this.frameSize / 2);

                    const pcmData = this.convertToPCM16(audioChunk);
                    this.sendAudioData(pcmData);
                }
            }, this.frameInterval);
        }

        updateAudioLevelDisplay(inputData) {
            // è®¡ç®—RMSéŸ³é‡
            const rms = Math.sqrt(
                inputData.reduce((sum, val) => sum + val * val, 0) / inputData.length
            );

            // æ˜ å°„åˆ°0-100çš„éŸ³é‡çº§åˆ«
            const volumeLevel = Math.min(100, Math.floor(rms * 200));

            // æ›´æ–°éŸ³é‡æ¡å’Œæ–‡å­—
            this.audioLevelBar.style.width = `${volumeLevel}%`;
            this.audioLevelText.textContent = `éŸ³é‡: ${volumeLevel}%`;
        }

        convertToPCM16(float32Array) {
            const buffer = new ArrayBuffer(float32Array.length * 2);
            const view = new DataView(buffer);
            
            for (let i = 0; i < float32Array.length; i++) {
                // æ ‡å‡†åŒ–å¹¶è½¬æ¢ä¸º16ä½æ•´æ•°
                const s = Math.max(-1, Math.min(1, float32Array[i]));
                view.setInt16(
                    i * 2, 
                    s < 0 ? s * 0x8000 : s * 0x7FFF, 
                    true  // å°ç«¯åºï¼Œç¬¦åˆç§‘å¤§è®¯é£æ ‡å‡†
                );
            }
            
            return buffer;
        }

        sendAudioData(pcmData) {
            try {
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    this.websocket.send(pcmData);

                    // æ›´æ–°éŸ³é¢‘ç»Ÿè®¡
                    this.audioStats.totalFramesSent++;
                    this.audioStats.totalBytesSent += pcmData.byteLength;
                    this.audioStats.lastSendTime = Date.now();
                }
            } catch (error) {
                this.log('âŒ éŸ³é¢‘æ•°æ®å‘é€å¤±è´¥', error);
            }
        }

        stop() {
            // åœæ­¢å½•éŸ³å’Œèµ„æºé‡Šæ”¾
            this.isRecording = false;
            
            // åœæ­¢éŸ³é¢‘å¤„ç†å®šæ—¶å™¨
            if (this.sendTimer) {
                clearInterval(this.sendTimer);
            }

            // å‘é€ç»“æŸä¿¡å·
            if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                this.websocket.send('END_STREAM');
            }

            // æ¸…ç†éŸ³é¢‘èµ„æº
            if (this.processor) {
                this.processor.disconnect();
            }
            
            if (this.mediaStreamSource) {
                this.mediaStreamSource.disconnect();
            }

            if (this.mediaStream) {
                this.mediaStream.getTracks().forEach(track => track.stop());
            }

            // é‡ç½®UI
            this.startBtn.disabled = false;
            this.stopBtn.disabled = true;
            this.status.textContent = 'å·²è¿æ¥';
            this.status.className = 'status connected';
            this.audioLevelBar.style.width = '0%';
            this.audioLevelText.textContent = 'éŸ³é‡: 0%';

            // è®°å½•éŸ³é¢‘ç»Ÿè®¡ä¿¡æ¯
            this.log(`ğŸ“Š éŸ³é¢‘ä¼ è¾“ç»Ÿè®¡: æ€»å¸§æ•°=${this.audioStats.totalFramesSent}, æ€»å­—èŠ‚æ•°=${this.audioStats.totalBytesSent}`);
        }

        handleServerResponse(responseData) {
            const timestamp = new Date().toLocaleString();
            
            try {
                // å°è¯•è§£æJSON
                const parsedData = JSON.parse(responseData);
                
                // æ›´æ–°æœåŠ¡ç«¯å“åº”åŒºåŸŸ
                const responseElement = document.createElement('div');
                responseElement.className = 'response-item';
                responseElement.innerHTML = `
                    <div class="response-timestamp">[${timestamp}]</div>
                    <div class="response-content">${JSON.stringify(parsedData, null, 2)}</div>
                `;
                this.serverResponses.prepend(responseElement);

                // å¤„ç†è½¬å†™ç»“æœ
                if (parsedData.text) {
                    const transcriptionArea = this.transcriptionText;
                    const transcriptElement = document.createElement('div');
                    transcriptElement.className = parsedData.isFinal ? 'final-text' : 'real-time-text';
                    transcriptElement.textContent = `[${timestamp}] ${parsedData.text}`;
                    transcriptionArea.appendChild(transcriptElement);
                    transcriptionArea.scrollTop = transcriptionArea.scrollHeight;
                }

            } catch (error) {
                // å¤„ç†éJSONå“åº”
                const rawResponseElement = document.createElement('div');
                rawResponseElement.className = 'response-item';
                rawResponseElement.innerHTML = `
                    <div class="response-timestamp">[${timestamp}]</div>
                    <div class="response-content">${responseData}</div>
                `;
                this.serverResponses.prepend(rawResponseElement);
            }
        }

        clearAll() {
            this.transcriptionText.innerHTML = 'ç­‰å¾…å¼€å§‹è¯­éŸ³è¯†åˆ«...';
            this.serverResponses.innerHTML = 'ç­‰å¾…æœåŠ¡ç«¯å“åº”...';
            this.debugInfo.innerHTML = 'è¯Šæ–­ä¿¡æ¯å°†åœ¨æ­¤å¤„æ˜¾ç¤º...';
        }

        // å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜
    }
        
    // é¡µé¢åŠ è½½ååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        const recorder = new AudioRecorder({
            wsUrl: 'wss://0cea-101-44-83-177.ngrok-free.app/ws/transcribe'
        });
    });
    </script>
</body>
</html>

